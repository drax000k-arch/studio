/**
 * @fileoverview Firestore Security Rules for Advisify AI.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user data, decision scenarios, and decision options.
 * Comments are stored in a top-level collection with public read access but owner-only write access.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles; only the authenticated user can access their own profile.
 * - /users/{userId}/decisionScenarios/{decisionScenarioId}: Stores decision scenarios created by a user; only the owning user can manage them.
 * - /users/{userId}/decisionScenarios/{decisionScenarioId}/options/{decisionOptionId}: Stores decision options for a given scenario; only the owning user can manage them.
 * - /comments/{commentId}: Stores comments. Anyone can read comments, but only the comment's author can edit or delete it.
 *
 * Key Security Decisions:
 * - Users can only access their own data.
 * - Users cannot list all users in the `/users` collection.
 * - Public read access is granted for the `/comments` collection to facilitate community interaction.
 * - Data validation is limited to authorization-critical fields (e.g., userId, scenarioId) to support rapid prototyping.
 *
 * Denormalization for Authorization:
 * - The `Comment` entity denormalizes the `userId` to enable owner-only write rules on the `/comments` collection. This avoids the need to query a separate user document.
 * - The `DecisionScenario` entity denormalizes the `userId` to enable owner-only write rules on the `/users/{userId}/decisionScenarios/{decisionScenarioId}` collection.
 * - The `DecisionOption` entity denormalizes the `scenarioId` to enable owner-only write rules on the `/users/{userId}/decisionScenarios/{decisionScenarioId}/options/{decisionOptionId}` collection.
 *
 * Structural Segregation:
 * - Public comments are stored in the top-level `/comments` collection, separate from user-specific data under `/users/{userId}`, to enable public read access without compromising user data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures the /users/{userId} collection to only allow access to the owning user.
     * @path /users/{userId}
     * @allow (create) - Authenticated user with UID 'user_abc' can create their user document where userId == 'user_abc'.
     * @allow (get, update, delete) - Authenticated user with UID 'user_abc' can get, update, or delete their user document where userId == 'user_abc'.
     * @deny (create) - Authenticated user with UID 'user_xyz' cannot create a user document for userId 'user_abc'.
     * @deny (get, update, delete) - Authenticated user with UID 'user_xyz' cannot get, update, or delete the user document for userId 'user_abc'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if request.auth.uid == userId;
      allow list: if false;
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId;
      allow delete: if request.auth.uid == userId;
    }

    /**
     * @description Secures the /users/{userId}/decisionScenarios/{decisionScenarioId} collection to only allow access to the owning user.
     * @path /users/{userId}/decisionScenarios/{decisionScenarioId}
     * @allow (create) - Authenticated user with UID 'user_abc' can create a decision scenario under their user document.
     * @allow (get, update, delete) - Authenticated user with UID 'user_abc' can get, update, or delete a decision scenario under their user document.
     * @deny (create) - Authenticated user with UID 'user_xyz' cannot create a decision scenario under user 'user_abc'.
     * @deny (get, update, delete) - Authenticated user with UID 'user_xyz' cannot get, update, or delete a decision scenario under user 'user_abc'.
     * @principle Enforces path-based ownership.
     */
    match /users/{userId}/decisionScenarios/{decisionScenarioId} {
      allow get: if request.auth.uid == userId;
      allow list: if false;
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId;
      allow delete: if request.auth.uid == userId;
    }

    /**
     * @description Secures the /users/{userId}/decisionScenarios/{decisionScenarioId}/options/{decisionOptionId} collection to only allow access to the owning user.
     * @path /users/{userId}/decisionScenarios/{decisionScenarioId}/options/{decisionOptionId}
     * @allow (create) - Authenticated user with UID 'user_abc' can create a decision option under their decision scenario.
     * @allow (get, update, delete) - Authenticated user with UID 'user_abc' can get, update, or delete a decision option under their decision scenario.
     * @deny (create) - Authenticated user with UID 'user_xyz' cannot create a decision option under user 'user_abc''s scenario.
     * @deny (get, update, delete) - Authenticated user with UID 'user_xyz' cannot get, update, or delete a decision option under user 'user_abc''s scenario.
     * @principle Enforces path-based ownership.
     */
    match /users/{userId}/decisionScenarios/{decisionScenarioId}/options/{decisionOptionId} {
      allow get: if request.auth.uid == userId;
      allow list: if false;
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId;
      allow delete: if request.auth.uid == userId;
    }

    /**
     * @description Secures the /comments/{commentId} collection, allowing public read access but restricting write access to the comment owner.
     * @path /comments/{commentId}
     * @allow (get, list) - Any user, authenticated or not, can read comments.
     * @allow (create) - Authenticated user with UID 'user_abc' can create a comment.
     * @allow (update, delete) - Authenticated user with UID 'user_abc' can update or delete their own comment.
     * @deny (update, delete) - Authenticated user with UID 'user_xyz' cannot update or delete a comment created by user 'user_abc'.
     * @principle Allows public reads while enforcing ownership for writes.
     */
    match /comments/{commentId} {
      allow get: if true;
      allow list: if true;
      allow create: if request.auth != null;
      allow update: if request.auth.uid == resource.data.userId;
      allow delete: if request.auth.uid == resource.data.userId;
    }

    /**
     * @description Addresses the reported error.  Granting public read access to the `community-posts` collection.
     * @path /community-posts
     * @allow (get, list) - Any user, authenticated or not, can read posts.
     * @principle Allows public reads.
     */
    match /community-posts {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}