/**
 * @fileOverview Firestore Security Rules for the Advisify AI application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user data, decision scenarios, and decision options.
 * Comments are stored in a top-level collection, enabling public read access but restricting write access to authenticated users.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only by the user themselves.
 * - /users/{userId}/decisionScenarios/{decisionScenarioId}: Stores decision scenarios created by the user.
 * - /users/{userId}/decisionScenarios/{decisionScenarioId}/options/{decisionOptionId}: Stores options for each decision scenario.
 * - /comments/{commentId}: Stores comments related to decision scenarios. Write access is restricted to authenticated users.
 *
 * Key Security Decisions:
 * - User listing is disallowed for privacy.
 * - Decision scenarios and options are strictly user-owned.
 * - Comments are publicly readable but writable only by authenticated users, with the author retaining deletion rights.
 *
 * Denormalization for Authorization:
 * - The `DecisionScenario` and `DecisionOption` entities both contain the `userId` of their creator, enabling easy validation of ownership.
 * - The `Comment` entity contains the `userId` of the author and the `scenarioId` it belongs to.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects user profile data. Only the authenticated user can read or write their own profile.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile.
     *    - Auth: { uid: 'user123' }
     *    - Request Data: { id: 'user123', username: 'testuser', email: 'test@example.com', registrationDate: '2024-01-01' }
     * @allow (get) User with ID 'user123' can read their profile.
     *    - Auth: { uid: 'user123' }
     * @allow (update) User with ID 'user123' can update their profile.
     *    - Auth: { uid: 'user123' }
     * @allow (delete) User with ID 'user123' can delete their profile.
     *    - Auth: { uid: 'user123' }
     * @deny (create) User with ID 'user456' cannot create a profile with ID 'user123'.
     *    - Auth: { uid: 'user456' }
     *    - Request Data: { id: 'user123', username: 'testuser', email: 'test@example.com', registrationDate: '2024-01-01' }
     * @deny (get) User with ID 'user456' cannot read the profile of user 'user123'.
     *    - Auth: { uid: 'user456' }
     * @principle Enforces document ownership for reads and writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Disallow user listing for privacy.
      allow create: if request.auth.uid == userId;
      allow update: if isExistingOwner(userId); // Enforce immutability of userId
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects decision scenarios nested under a user. Only the owning user can manage their scenarios.
     * @path /users/{userId}/decisionScenarios/{decisionScenarioId}
     * @allow (create) User with ID 'user123' can create a scenario under their profile.
     *    - Auth: { uid: 'user123' }
     *    - Request Data: { id: 'scenario1', userId: 'user123', title: 'My Scenario', description: 'A description', postDate: '2024-01-01' }
     * @allow (get) User with ID 'user123' can read a scenario under their profile.
     *    - Auth: { uid: 'user123' }
     * @allow (update) User with ID 'user123' can update a scenario under their profile.
     *    - Auth: { uid: 'user123' }
     * @allow (delete) User with ID 'user123' can delete a scenario under their profile.
     *    - Auth: { uid: 'user123' }
     * @deny (create) User with ID 'user456' cannot create a scenario under the 'user123' profile.
     *    - Auth: { uid: 'user456' }
     *    - Request Data: { id: 'scenario1', userId: 'user123', title: 'My Scenario', description: 'A description', postDate: '2024-01-01' }
     * @deny (get) User with ID 'user456' cannot read a scenario under the 'user123' profile.
     *    - Auth: { uid: 'user456' }
     * @principle Enforces path-based document ownership for decision scenarios.
     */
    match /users/{userId}/decisionScenarios/{decisionScenarioId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects decision options nested under a user's decision scenario. Only the owning user can manage options.
     * @path /users/{userId}/decisionScenarios/{decisionScenarioId}/options/{decisionOptionId}
     * @allow (create) User with ID 'user123' can create an option under their scenario.
     *    - Auth: { uid: 'user123' }
     *    - Request Data: { id: 'option1', scenarioId: 'scenario1', text: 'Option A', aiWeighting: 0.5 }
     * @allow (get) User with ID 'user123' can read an option under their scenario.
     *    - Auth: { uid: 'user123' }
     * @allow (update) User with ID 'user123' can update an option under their scenario.
     *    - Auth: { uid: 'user123' }
     * @allow (delete) User with ID 'user123' can delete an option under their scenario.
     *    - Auth: { uid: 'user123' }
     * @deny (create) User with ID 'user456' cannot create an option under the 'user123' scenario.
     *    - Auth: { uid: 'user456' }
     *    - Request Data: { id: 'option1', scenarioId: 'scenario1', text: 'Option A', aiWeighting: 0.5 }
     * @deny (get) User with ID 'user456' cannot read an option under the 'user123' scenario.
     *    - Auth: { uid: 'user456' }
     * @principle Enforces path-based document ownership for decision options.
     */
    match /users/{userId}/decisionScenarios/{decisionScenarioId}/options/{decisionOptionId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects comments. Anyone can read comments, but only authenticated users can create them. The creator can update and delete.
     * @path /comments/{commentId}
     * @allow (get) Any user can read any comment.
     * @allow (list) Any user can list all comments.
     * @allow (create) Authenticated user 'user123' can create a comment.
     *    - Auth: { uid: 'user123' }
     *    - Request Data: { id: 'comment1', userId: 'user123', scenarioId: 'scenario1', text: 'A comment', commentDate: '2024-01-01' }
     * @allow (update) Authenticated user 'user123' can update their own comment.
     *    - Auth: { uid: 'user123' }
     * @allow (delete) Authenticated user 'user123' can delete their own comment.
     *    - Auth: { uid: 'user123' }
     * @deny (create) Unauthenticated user cannot create a comment.
     *    - Auth: null
     *    - Request Data: { id: 'comment1', userId: 'user123', scenarioId: 'scenario1', text: 'A comment', commentDate: '2024-01-01' }
     * @deny (update) User 'user456' cannot update a comment created by 'user123'.
     *    - Auth: { uid: 'user456' }
     * @deny (delete) User 'user456' cannot delete a comment created by 'user123'.
     *    - Auth: { uid: 'user456' }
     * @principle Allows public read access for comments, but restricts write access to authenticated users and enforces ownership for updates and deletes.
     */
    match /comments/{commentId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner() {
        return request.auth.uid == resource.data.userId;
      }
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && isExistingOwner();
      allow delete: if isSignedIn() && isExistingOwner();
    }
  }
}